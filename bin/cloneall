#!/bin/bash

function checkargs {
    num_args=$1
    expected_args=$2
    msg=$3
    if (( $num_args < $expected_args )) ;
    then
        echo $msg
        exit $expected_args
    fi
}

function cloneall_gitlab {
    source "$HOME/.env"
    PROFILE=$1
    GROUP=$2
    GL_HOST=$3
    eval PAT=\$${1}_PAT
    echo Cloning all repositories for Gitlab group $GROUP on $GL_HOST    
    for repo in $(curl -s --header "PRIVATE-TOKEN: $PAT" "https://$GL_HOST/api/v4/groups/$GROUP" | jq -r ".projects[].ssh_url_to_repo");
    do
        git clone $repo;
    done
}

function cloneall_github {
    GHORG=$1
    echo Cloning all repositories in org $GHORG
    curl "https://api.github.com/orgs/$GHORG/repos?per_page=1000" | grep -o 'git@[^"]*' | xargs -L1 git clone    
}

checkargs $# 1 "First arg must be a profile (GH, GL, GL_DPS)"
PROFILE=$1
if [[ $PROFILE == GH* ]]
then
    cloneall_github $2
elif [[ $PROFILE == GL* ]]
then
    checkargs $# 2 "Second arg must be a Gitlab group ID"
    cloneall_gitlab $PROFILE $2 ${3:-"gitlab.com"}
else
    echo "Failed to execute any clone with profile '$PROFILE'"
fi



